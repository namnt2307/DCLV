{%extends 'fhir/base.html'%}
{%block url1%}'{%url 'fhir:hanhchinh' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}
{%block url2%}'{%url 'fhir:dangky' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}
{%block url3%}'{%url 'fhir:hoibenh' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}
{%block url5%}'{%url 'fhir:xetnghiem' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}
{%block url4%}'{%url 'fhir:toanthan' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}
{%comment%}{%block url8%}'{%url 'fhir:thuthuat' group_name user_name data.Patient.identifier data.Encounter.identifier%}'{%endblock%}{%endcomment%}{%block url7%}'{%url 'fhir:thuoc' group_name user_name data.Patient.identifier data.Encounter.identifier %}'{%endblock%}
{%block url6%}'{%url 'fhir:hinhanh' group_name user_name data.Patient.identifier data.Encounter.identifier %}'{%endblock%}
{% load widget_tweaks %}
{%block function%}
{{discharge_conditions|length|add:1}}
<h1>KẾT QUẢ</h1>
<div>
    
    <h2>+ Bệnh chính</h2>
        <div>
            <table>
                <th class="cell-data-2">Tên bệnh</th>
                <th class="cell-data-2">Mức độ</th>
                <th></th>
                {%if discharge_conditions.all %}
                <th></th>
                {% endif %}
                {% for condition in discharge_conditions %}
                <tbody id="{{condition.condition_identifier}}-data">
                    <tr>
                        <td class="cell-data-2">{{condition.condition_code}}                       </td>
                        <td class="cell-data-2">{{severity|get_item:condition.condition_severity}}</td>
                        <td><button onclick="toggleDisplay('{{condition.condition_identifier}}')">Chỉnh sửa</button></td>
                        <td>
                            <form action="{% url 'fhir:delete' %}" method="POST">
                                {%csrf_token%}
                                <input type="hidden" name="_method" value="delete">
                                <input type="hidden" name="resource_type" id="" value="condition">
                                <input type="hidden" name="url_next" value="{{request.get_full_path}}">
                                <input type="hidden" name="resource_identifier" value="{{condition.condition_identifier}}">
                                <button type="submit">Xóa</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
                <tbody style="display: none;" id="{{condition.condition_identifier}}-form">
                    <tr>
                        <form action="" method="POST">
                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                            <input type="hidden" name="classifier" id="" value="discharge">
                            <input type="hidden" name="condition_identifier" value="{{condition.condition_identifier}}">
                            {%with 'value:'|add:condition.condition_code as code%}
                                <td class="cell-data-2">
                                    <input list="comorbidity_diseases" name="condition_code" value="{{condition.condition_code}}">
                                    <datalist id="comorbidity_diseases">
                                        {% for disease in comorbidity_diseases %}
                                            <option value="{{disease.disease_search}}">
                                        {% endfor %}
                                    </datalist>
                                </td>
                            {%endwith%}
                            {%with 'value:'|add:condition.condition_severity as code%}
                                <td class="cell-data-2">{{condition_form.condition_severity|attr:code}}</td>
                            {%endwith%}
                            <td><button type="submit">Lưu</button></td>
                            <td><button type="button" onclick="toggleDisplay('{{condition.condition_identifier}}')">Hủy</button></td>
                        </form>
                    </tr>
                </tbody>
                {% endfor %}
                    
                <tr>
                    <form action="" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="classifier" id="" value="discharge">
                        <td class="cell-data-2">
                            <input list="discharge_diseases" name="condition_code" id="discharge_disease" onchange="test('discharge_disease')">
                            <datalist id="discharge_diseases">
                                {% for disease in discharge_diseases %}
                                    <option value="{{disease.disease_search}}">
                                {% endfor %}
                            </datalist>
                        </td>
                        <td class="cell-data-2">{{condition_form.condition_severity}}</td>
                        <td><button type="submit" onclick="toggleDisplay('{{condition.condition_identifier}}')">Thêm</button></td>
                        {% if discharge_conditions.all %}
                            <td></td>
                        {%endif%}
                    </form>
                </tr>
            </table>
        </div>
    <h2>+ Bệnh kèm theo</h2>
    <div>
        <table>
            <th class="cell-data-2">Tên bệnh</th>
            <th class="cell-data-2">Mức độ</th>
            <th></th>
            {%if comorbidity_conditions.all %}
            <th></th>
            {% endif %}
            {% for condition in comorbidity_conditions %}
            <tbody id="{{condition.condition_identifier}}-data">
                <tr>
                    <td class="cell-data-2">{{condition.condition_code}}</td>
                    <td class="cell-data-2">{{severity|get_item:condition.condition_severity}}</td>
                    <td><button type="button" onclick="toggleDisplay('{{condition.condition_identifier}}')">Chỉnh sửa</button></td>
                    <td>
                        <form action="{% url 'fhir:delete' %}" method="POST">
                            {%csrf_token%}
                            <input type="hidden" name="_method" value="delete">
                            <input type="hidden" name="resource_type" id="" value="condition">
                            <input type="hidden" name="url_next" value="{{request.get_full_path}}">
                            <input type="hidden" name="resource_identifier" value="{{condition.condition_identifier}}">
                            <button type="submit">Xóa</button>
                        </form>
                    </td>
                </tr>
            </tbody>
            <tbody style="display: none;" id="{{condition.condition_identifier}}-form">
                <tr>
                    <form action="" method="POST">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="classifier" id="" value="comorbidity">
                        <input type="hidden" name="condition_identifier" value="{{condition.condition_identifier}}">
                        {%with 'value:'|add:condition.condition_code as code%}
                            <input list="comorbidity_diseases" name="condition_code" id="comorbidity_disease">
                            <datalist id="comorbidity_diseases">
                                {% for disease in d_diseases %}
                                    <option value="{{disease.disease_search}}">
                                {% endfor %}
                            </datalist>
                        {%endwith%}
                        {%with 'value:'|add:condition.condition_severity as code%}
                            <td class="cell-data-2">{{condition_form.condition_severity|attr:code}}</td>
                        {%endwith%}
                        <td><button type="submit">Lưu</button></td>
                        <td><button type="button" onclick="toggleDisplay('{{condition.condition_identifier}}')">Hủy</button></td>                        
                    </form>
                </tr>
            </tbody>
            {% endfor %}
            <tr>
                <form action="" method="POST">
                {% csrf_token %}
                    <td>
                        <input type="hidden" name="classifier" id="" value="comorbidity">
                        <input list="comorbidity_diseases" name="condition_code" id="comorbidity_disease">
                        <datalist id="comorbidity_diseases">
                            {% for disease in comorbidity_diseases %}
                                <option value="{{disease.disease_search}}">
                            {% endfor %}
                        </datalist>
                    </td>
                    <td class="cell-data-2">{{condition_form.condition_severity}}</td>
                    <td><button type="submit">Thêm</button></td>
                </form>
            </tr>
        </table>
    </div>
</div>
<h1>THUỐC</h1>
<table>
    <thead>
        <th class="cell-data-6">Thuốc</th>
        <th class="cell-data-6">Lý do dùng thuốc</th>
        {%comment%}<th class="cell-data-8">Bắt đầu dùng thuốc từ</th>{%endcomment%}
        <th class="cell-data-6">Tần suất dùng thuốc</th>
        <th class="cell-data-6">Liều dùng</th>
        <th class="cell-data-6">Thời gian sử dụng</th>
        <th class="cell-data-6">Đường dùng</th>
        <th></th>
        {%comment%}<th class="cell-data-8">Ngày chỉ định</th>{%endcomment%}
    </thead>
    
    {% if medications %}
    
        {% for medication in medications %}
            <tbody id="{{medication.medication_identifier}}-data">
                <tr>
                    <td class="cell-data-6">{{medication.medication_medication}}</td>
                    <td class="cell-data-6">{{medication.medication_reason_code}}</td>
                    {%comment%}<td class="cell-data-8">{{medication.medication_effective|date:"d-m-Y"}}</td>{%endcomment%}
                    <td class="cell-data-6">{{medication.dosage_frequency}}/{{medication.dosage_period}} {{unit|get_item:medication.dosage_period_unit}}</td>
                    <td class="cell-data-6">{{medication.dosage_quantity}}</td>
                    <td class="cell-data-6">{{medication.dosage_duration}} {{unit|get_item:medication.dosage_duration_unit}}</td>
                    <td class="cell-data-6">{{medication.dosage_route}}</td>
                    {%comment%}<td class="cell-data-8">{{medication.medication_date_asserted|date:"d-m-Y"}}</td>{%endcomment%}
                    <td><button class="submit-button" onclick="toggleDisplay('{{medication.medication_identifier}}')">Chỉnh sửa</button></td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align: left;">
                        <p>Thời điểm sử dụng: {{when|get_item:medication.dosage_when|capfirst}} {%if medication.dosage_offset != '0'%}{{medication.dosage_offset}} phút{%endif%}</p>
                        <p>Hướng dẫn thêm: {{medication.dosage_additional_instruction}}</p>
                        <p>Hướng dẫn đặc biệt: {{medication.dosage_patient_instruction}}</p>
                    </td>
                    <td>
                        <form action="{% url 'fhir:delete' %}" method="POST">
                            {%csrf_token%}
                            <input type="hidden" name="_method" value="delete">
                            <input type="hidden" name="resource_type" id="" value="medication_statement">
                            <input type="hidden" name="url_next" value="{{request.get_full_path}}">
                            <input type="hidden" name="resource_identifier" value="{{medication.medication_identifier}}">
                            <button type="submit">Xóa</button>
                        </form>
                    </td>
                </tr>
                
            </tbody>
            <tbody id="{{medication.medication_identifier}}-form" style="display: none;">   
                <form action="" method="POST" >
                    <tr>
                        <input type="hidden" name="classifier" id="" value="medication">
                        <input type="hidden" name="medication_identifier" value="{{medication.medication_identifier}}">
                        {%csrf_token%}

                        {%with 'value:'|add:medication.medication_medication as code%}
                            <td class="cell-data-6">{{medication_form.medication_medication|attr:code}}</td>
                        {%endwith%}
                    
                        {%with 'value:'|add:medication.medication_reason_code as code%}   
                            <td class="cell-data-6">{{medication_form.medication_reason_code|attr:code}}</td>
                        {%endwith%}
                    {%comment%}
                        {%with medication.medication_effective|date:'Y-m-d' as effective_date%}
                            {%with 'value:'|add:effective_date as code%}        
                                <td class="cell-data-8">{{medication_form.medication_effective|attr:code}}</td>
                            {%endwith%}
                        {%endwith%}
                    {%endcomment%}
                        <td class="cell-data-6">
                            {%with 'value:'|add:medication.dosage_frequency as code%}
                        
                                {{medication_form.dosage_frequency|attr:code}}
                            
                            {%endwith%}
                                <br>
                                /
                                <br>
                            {%with 'value:'|add:medication.dosage_period as code%}               
                                {{medication_form.dosage_period|attr:code}}
                                <br>
                                {{medication_form.dosage_period_unit}}
                            {%endwith%}
                        </td>

                        {%with 'value:'|add:medication.dosage_quantity as code%}
                            <td class="cell-data-6">{{medication_form.dosage_quantity|attr:code}}</td>
                        {%endwith%}

                        {%with 'value:'|add:medication.dosage_duration as code%}         
                            <td class="cell-data-6">
                                {{medication_form.dosage_duration|attr:code}}
                                <br>
                                {{medication_form.dosage_duration_unit}}
                            </td>
                        {%endwith%}



                        {%with 'value:'|add:medication.dosage_route as code%}
                            <td class="cell-data-6">{{medication_form.dosage_route|attr:code}}</td>
                        {%endwith%}
                        <td><button type="submit">Lưu</button></td>
                    </tr>
                    <tr>
                        <td colspan="6">
                            {%with 'value:'|add:medication.dosage_when as code%}                
                                <p>Thời điểm dùng thuốc: {{medication_form.dosage_when|attr:code}}
                            {%endwith%}
                
                            {%with 'value:'|add:medication.dosage_offset as code%}               
                                {{medication_form.dosage_offset|attr:code}} phút</p>
                            {%endwith%}

                            {%with 'value:'|add:medication.dosage_additional_instruction as code%}
                                <p>Hướng dẫn thêm: {{medication_form.dosage_additional_instruction|attr:code}}</p>
                            {%endwith%}

                            {%with 'value:'|add:medication.dosage_patient_instruction as code%}
                                <p>Hướng dẫn đặc biệt: {{medication_form.dosage_patient_instruction|attr:code}}</p>
                            {%endwith%}
                        </td>
                        <td><button type="button" onclick="toggleDisplay('{{medication.medication_identifier}}')">Hủy</button></td>
                    </tr>
                </form>
            </tbody>
        {% endfor %}
    {% endif %}
    <form action="" method="POST">
        <input type="hidden" name="classifier" id="" value="medication">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <tr>
            <td class="cell-data-6">{{medication_form.medication_medication}}</td>
            <td class="cell-data-6">{{medication_form.medication_reason_code}}</td>
            {%comment%}<td class="cell-data-8">{{medication_form.medication_effective}}</td>{%endcomment%}
            <td class="cell-data-6">
            {{medication_form.dosage_frequency}}
            <br>
            / 
            <br>
            {{medication_form.dosage_period}} {{medication_form.dosage_period_unit}}
            </td>
            <td class="cell-data-6">{{medication_form.dosage_quantity}}</td>
            <td class="cell-data-6">{{medication_form.dosage_duration}} {{medication_form.dosage_duration_unit}}</td>
            <td class="cell-data-6">{{medication_form.dosage_route}}</td>
            <td rowspan="2"><button type="submit">Thêm Thuốc</button></td>
        </tr>
        <tr>
            <td colspan="6" style="text-align: left;">
                <p>Thời điểm dùng thuốc: {{medication_form.dosage_when}} {{medication_form.dosage_offset}} phút</p>
                <p>Hướng dẫn thêm: {{medication_form.dosage_additional_instruction}}</p>
                <p>Hướng dẫn đặc biệt: {{medication_form.dosage_patient_instruction}}</p>       
            </td>
        </tr>
    </form>
</table>
{% comment %}
<div>
    <div class="formPopup" id="thuocForm">
        <div class="formContainer">
            <form action="" method="POST">
                {%csrf_token%}
                {{medication_form.medication_medication.label}}: {{medication_form.medication_medication}}
                <br>
                {{medication_form.medication_reason_code.label}}: {{medication_form.medication_reason_code}}
                <br>
                {{medication_form.medication_effective.label}}: {{medication_form.medication_effective}}
                <br>
                {{medication_form.dosage_frequency.label}}: {{medication_form.dosage_frequency}}
                <br>
                {{medication_form.dosage_period.label}}: {{medication_form.dosage_period}} {{medication_form.dosage_period_unit}}
                <br>
                {{medication_form.dosage_duration.label}}: {{medication_form.dosage_duration}} {{medication_form.dosage_duration_unit}}
                <br>
                {{medication_form.dosage_route.label}}: {{medication_form.dosage_route}}
                <br>
                {{medication_form.dosage_quantity.label}}: {{medication_form.dosage_quantity}}
                <br>
                {{medication_form.dosage_when.label}}: {{medication_form.dosage_when}}
                <br>
                {{medication_form.dosage_offset.label}}: {{medication_form.dosage_offset}}
                <br>
                {{medication_form.dosage_additional_instruction.label}}: {{medication_form.dosage_additional_instruction}}
                <br>
                {{medication_form.dosage_patient_instruction.label}}: {{medication_form.dosage_patient_instruction}}
                <br>
                <button type="submit" class="btn">Add</button>
                <button type="button" class="btn cancel" onclick="closeForm('thuocForm')">Close</button>
            </form>
        </div>
    </div>
</div>
{% endcomment %}
<script>
    function whenFunction(){
        var select = document.getElementById('id_dosage_when');
        console.log(select);
        var value = select.getAttribute('value');
        console.log(value);
    }
    function toggleDisplay(elementId){
        data = document.getElementById(elementId + '-data');
        form = document.getElementById(elementId + '-form');
        if (data.style.display == 'none'){
            data.style.display = 'table-row-group';
            form.style.display = 'none';
        }
        else {
            data.style.display = 'none';
            form.style.display = 'table-row-group';
        }
    }
    function test(elementId){
        element = document.getElementById(elementId);
        console.log(element.value);
        if(element.value.includes(' ')){
            code = element.value.split(' ')[-1];
        }
    }
</script>
{%endblock%}